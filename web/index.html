<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video game sales VP</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-2 col-xl-1">
                <img src="./src/ferit.png" alt="Ferit logo" height="115">
            </div>
            <div class="col-sm-10 col-xl-6 pt-3">
                <h1>Video game sales</h1>
            </div>
            <div class="col-sm-12 col-xl-5">
                <div class="container">
                    <ul class="list-group list-group-horizontal justify-content-end p-3">
                        <li class="list-group-item text-body">
                            <button class="btn dropdown-toggle" type="button" id="dropdownMenuButtonGenre"
                                data-toggle="dropdown">Genre</button>
                            <div class="dropdown-menu" aria-labelledby="dropdownMenuButtonGenre">
                                <a class="dropdown-item" id="buttonAction">Action</a>
                                <a class="dropdown-item" id="buttonActionAdventure">Action-Adventure</a>
                                <a class="dropdown-item" id="buttonAdventure">Adventure</a>
                                <a class="dropdown-item" id="buttonFighting">Fighting</a>
                                <a class="dropdown-item" id="buttonMisc">Miscellaneous</a>
                                <a class="dropdown-item" id="buttonMusic">Music</a>
                                <a class="dropdown-item" id="buttonParty">Party</a>
                                <a class="dropdown-item" id="buttonPlatform">Platform</a>
                                <a class="dropdown-item" id="buttonPuzzle">Puzzle</a>
                                <a class="dropdown-item" id="buttonRacing">Racing</a>
                                <a class="dropdown-item" id="buttonRolePlaying">Role-Playing</a>
                                <a class="dropdown-item" id="buttonShooter">Shooter</a>
                                <a class="dropdown-item" id="buttonSimulation">Simulation</a>
                                <a class="dropdown-item" id="buttonSports">Sports</a>
                                <a class="dropdown-item" id="buttonStrategy">Strategy</a>
                            </div>
                        </li>
                        <li class="list-group-item text-body">
                            <button class="btn dropdown-toggle" type="button" id="dropdownMenuButtonPlatform"
                                data-toggle="dropdown">Platform</button>
                            <div class="dropdown-menu" aria-labelledby="dropdownMenuButtonPlatform">
                                <a class="dropdown-item" id="buttonN64">Nintendo 64</a>
                                <a class="dropdown-item" id="buttonSNES">Super Nintendo Entertainment System</a>
                                <a class="dropdown-item" id="buttonNS">Nintendo Switch</a>
                                <a class="dropdown-item" id="buttonWii">Wii</a>
                                <a class="dropdown-item" id="buttonWiiU">WiiU</a>
                                <a class="dropdown-item" id="buttonPS">PlayStation</a>
                                <a class="dropdown-item" id="buttonPS2">PlayStation 2</a>
                                <a class="dropdown-item" id="buttonPS3">PlayStation 3</a>
                                <a class="dropdown-item" id="buttonPS4">PlayStation 4</a>
                                <a class="dropdown-item" id="buttonPSV">PlayStation Vita</a>
                                <a class="dropdown-item" id="buttonX360">Xbox 360</a>
                                <a class="dropdown-item" id="buttonXONE">Xbox One</a>
                                <a class="dropdown-item" id="buttonPC">PC</a>
                            </div>
                        </li>
                        <li class="list-group-item text-body">
                            <button class="btn dropdown-toggle" type="button" id="dropdownMenuButtonRegion"
                                data-toggle="dropdown">Region</button>
                            <div class="dropdown-menu" aria-labelledby="dropdownMenuButtonRegion">
                                <a class="dropdown-item" id="buttonGlobal">Global</a>
                                <a class="dropdown-item" id="buttonNA">North America</a>
                                <a class="dropdown-item" id="buttonPAL">Europe</a>
                                <a class="dropdown-item" id="buttonJP">Japan</a>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row">
                <div class="col-lg-9 p-2" id="svgContainer"></div>
                <div class="col-lg-3">
                    <div class="card">
                        <div class="card-header">Current settings:</div>
                        <div class="card-body">
                            <p id="textGenre">Genre: #</p>
                            <p id="textPlatform">Platform: #</p>
                            <p id="textRegion">Region: #</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-header" id="textClickedGameTitle">
                            <div id="loaderSpinner"></div>Game: click on a member of the pie chart to display more data
                        </div>
                        <div class="card-body">
                            <table class="table table-bordered" id="tableClicked">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Genre</th>
                                        <th>ESRB rating</th>
                                        <th>Platform</th>
                                        <th>Publisher</th>
                                        <th>Developer</th>
                                        <th>Region sales</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>N/A</td>
                                        <td>N/A</td>
                                        <td>N/A</td>
                                        <td>N/A</td>
                                        <td>N/A</td>
                                        <td>N/A</td>
                                        <td>N/A</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="card-footer">
                            <p class="text-danger">Warning! Will lag considering the dataset is several MB in size and
                                dataframe-js doesn't play well with such sizes</p>
                            <p>Made by Anto Tufeković, <a href="https://github.com/ATufekovic/VP_projekt"
                                    target="_blank">GitHub</a></p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</body>
<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="https://gmousse.github.io/dataframe-js/dist/dataframe.min.js"></script>
<script>
    var DataFrame = dfjs.DataFrame;

    class DataManipulator {
        /**
     * Klasa koja obavlja sve poslove vezane za manipulaciju podatcima te prikazom u grafickom obliku - podrzano samo pie graph i csv datoteke
    */
        constructor(verbose = false) {
            this.data = null;
            this.verbose = verbose;

            this.genres = ["Action", "ActionAdventure", "Adventure", "Fighting", "Misc", "Music", "Party", "Platform", "Puzzle", "Racing", "Shooter", "Simulation", "Sports", "Strategy"];
            this.genreButtons = [];
            this.selectedGenre = "Action";

            this.platforms = ["N64", "SNES", "NS", "Wii", "WiiU", "PS", "PS2", "PS3", "PS4", "PSV", "X360", "XONE", "PC"];
            this.platformButtons = [];
            this.selectedPlatform = "N64";

            this.regions = ["Global", "NA", "PAL", "JP"];
            this.regionButtons = [];
            this.selectedRegion = "Global";

            this.settingInfoText = [];

            this.spinner = null;

            this.svgContainer = null;

            this.tableClicked = null;
            this.textClickedGameTitle = null;
        }
        /**
         * Funkcija koja bi se trebala pozivati nakon kreiranje klase da bi se pokrenuo proces dohvacanja svih potrebnih elemenata.
        */
        init() {
            //ucitaj podatke koristeci dataframe-js biblioteku
            DataFrame.fromCSV("src/smol.csv").then(df => {
                this.data = df.select('Name', 'Genre', 'ESRB_Rating', 'Platform', 'Publisher', 'Developer', 'Global_Sales', 'NA_Sales', 'PAL_Sales', 'JP_Sales', 'Year');
                if (this.verbose) {
                    console.log("Loaded " + this.data.count() + " row(s) into data");
                    console.log("Example:");
                    this.data.head(3).show();
                }
                //nakon ucitavanja pocni sve ostale elemente dohvacati i rijesi tipke

                this.setEvents();

                let settingGenre = document.querySelector("#textGenre");
                let settingPlatform = document.querySelector("#textPlatform");
                let settingRegion = document.querySelector("#textRegion");
                this.settingInfoText.push(settingGenre, settingPlatform, settingRegion);
                this.spinner = document.querySelector("#loaderSpinner");
                this.svgContainer = document.querySelector("#svgContainer");
                this.tableClicked = document.querySelector("#tableClicked");
                this.textClickedGameTitle = document.querySelector("#textClickedGameTitle");
                if (this.verbose) { console.log(this.settingInfoText); }

                //na kraju se prikaz osvježava
                this.updateDisplay();
            });
        }
        /**
         * Funkcija koja ide po tipkama u dropdown menu-ima te svaku tipku sa pripadajucim vrijednostima prosljedjuje dalje funkciji koja obraduje tipke
        */
        setEvents() {
            this.genres.forEach(genre => {
                let temp = document.querySelector("#button" + genre);
                this.eventClickHandlerChange(temp, "genre", genre);
                this.genreButtons.push(temp);

            });
            if (this.verbose) { console.log(this.genreButtons); }

            this.platforms.forEach(platform => {
                let temp = document.querySelector("#button" + platform);
                this.eventClickHandlerChange(temp, "platform", platform);
                this.platformButtons.push(temp);
            });
            if (this.verbose) { console.log(this.platformButtons); }

            this.regions.forEach(region => {
                let temp = document.querySelector("#button" + region);
                this.eventClickHandlerChange(temp, "region", region);
                this.regionButtons.push(temp);
            });
            if (this.verbose) { console.log(this.regionButtons); }
        }
        /**
         * Funkcija koja danoj tipci daje on click event ovisno o proslijedjenim varijablama te tada mijenjaju trenutno odabrane varijable za prikaz
        */
        eventClickHandlerChange(button, type, value) {
            if (type == "genre") {
                button.addEventListener("click", (e) => {
                    this.selectedGenre = value;
                    this.updateDisplay();
                });
            } else if (type == "platform") {
                button.addEventListener("click", (e) => {
                    this.selectedPlatform = value;
                    this.updateDisplay();
                });
            } else if (type == "region") {
                button.addEventListener("click", (e) => {
                    this.selectedRegion = value;
                    this.updateDisplay();
                });
            } else {
                console.log("Something went wrong with setting on click events with following parameters (button, type, value):");
                console.log(button);
                console.log(type);
                console.log(value);
            }
        }
        /**
         * Funkcija koja osvježava sadrzaj stranice jednom, mijenja prikaz odabranih varijabli te sam graf
        */
        updateDisplay() {
            if (this.verbose) {
                console.log(this.selectedGenre);
                console.log(this.selectedPlatform);
                console.log(this.selectedRegion);
            }

            this.settingInfoText[0].innerHTML = "Genre: " + this.selectedGenre;
            this.settingInfoText[1].innerHTML = "Platform: " + this.selectedPlatform;
            this.settingInfoText[2].innerHTML = "Region: " + this.selectedRegion;

            let dataArray = this.getTopTenFromData();
            this.showGraph(dataArray);
        }
        /**
         * Funkcija koja odabire potrebne stupce iz baze podataka te proslijeduje prvih deset (ili manje) natrag
        */
        getTopTenFromData() {
            let temp = this.data.select('Name', 'Genre', 'ESRB_Rating', 'Platform', 'Publisher', 'Developer', this.selectedRegion + '_Sales', 'Year').filter({ 'Genre': this.selectedGenre, 'Platform': this.selectedPlatform }).filter(row => row.get(this.selectedRegion + '_Sales') != "");
            if (this.verbose) {
                console.log("Gotten " + temp.count() + " row(s) of data");
                console.log(temp.head(10).toArray());
            }
            return temp.head(10).toArray();
        }
        /**
         * Funkcija koja prvo provjerava dali svg kontejner ima clanove, ako da obrisi ih, nakon toga stvara novi svg element sa grafom koji sadrzi vrijednosti proslijedjenih podataka
        */
        showGraph(dataArray) {
            if (this.svgContainer.hasChildNodes()) {
                this.svgContainer.innerHTML = "";
            }
            let width = 800;
            let height = 800;
            let outerRadius = (Math.min(width, height) / 2) * 0.9;
            let innerRadius = 0;
            let color = d3.scaleOrdinal(["#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd", "#8c564b", "#e377c2", "#7f7f7f", "#bcbd22", "#17becf"]);

            let svg = d3.select("#svgContainer")
                .append("svg")
                .attr("width", width)
                .attr("height", height);

            let pie = d3.pie()
                .value(d => parseFloat((d[6]).replace(',', '.')))
                .sort(null);

            let arc = d3.arc()
                .innerRadius(innerRadius)
                .outerRadius(outerRadius);

            let pieArcs = svg.selectAll("g.pie")
                .data(pie(dataArray))
                .enter()
                .append("g")
                .attr("class", "pie")
                .attr("transform", "translate(" + (width / 2) + ", " + (height / 2) + ")");
            pieArcs.append("path")
                .attr("fill", function (d, i) { return color(i); })
                .attr("d", arc);

            let pieArcsText = svg.selectAll("g.text")
                .data(pie(dataArray))
                .enter()
                .append("g")
                .attr("class", "pieText")
                .attr("transform", "translate(" + (width / 2) + ", " + (height / 2) + ")");
            pieArcsText.append("text")
                .attr("transform", function (d) {
                    var sum = 0.0;
                    var pi = Math.PI;
                    sum += d.endAngle + d.startAngle;
                    sum /= 2;
                    sum *= (180 / pi);
                    if (sum < 180) {
                        sum -= 90;
                    }
                    else if (sum >= 180) {
                        sum += 90;
                    }
                    return "translate(" + arc.centroid(d) + ") rotate(" + sum + ")";
                })
                .attr("text-anchor", "middle")
                .attr("class", "text")
                .text(function (d) { return d.data[0] + ": " + d.data[6] + "M"; });
            pieArcs.on("click", (d) => {
                if (this.verbose) { console.log(d.data); }
                let temp = "<td>" + d.data[0] + "</td>" + "<td>" + d.data[1] + "</td>" + "<td>" + d.data[2] + "</td>" + "<td>" + d.data[3] + "</td>" + "<td>" + d.data[4] + "</td>" + "<td>" + d.data[5] + "</td>" + "<td>" + d.data[6] + " Million units</td>";
                this.tableClicked.rows[1].innerHTML = temp;
                this.textClickedGameTitle.innerHTML = "<div id='loaderSpinner'></div>Game: " + d.data[0];
            });

        }
    }
    let dm = new DataManipulator();
    dm.init();
</script>

</html>